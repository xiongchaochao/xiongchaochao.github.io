---
title: windows样本高级动态分析二
date: 2019-10-17 10:49:21
tags: windows病毒分析
---

# 引言

本片文章通过实例1引入以下内容：

* 混淆静态分析技术：加密字符串
* 将socket绑定到stdout、stderr、stdin来创建简单的反向shell

通过实例2引入一下内容，但是实例2的流程不走病毒分析流程：

* 区分动态、静态加载的DLL

* 多个DLL加载，段虚拟地址相同的内存加载
* 手动添加结构体

# 目标

通过样本分析，继续熟练掌握OllyDbg的使用

# 流程

## 实例1

1. 基础静态分析
2. 高级静态、动态结合分析

## 实例2

Q&A

# 实践过程

## 实例1

Lab09-02.exe

### 基础静态分析

是一个有界面的样本，存在socket网络连接但是并未发现有交互行为

subsystem:	GUI

```
导入函数：
115 (WSAStartup)
WSASocketA
52 (gethostbyvalue)
3 (closesocket)
116 (WSACleanup)
9 (htons)
4 (connect)
```

### 高级动静结合分析

首先判断样本名称是否为"ocl.exe"，不是就会退出并返回1，修改名称继续分析

![1571283857165](1571283857165.png)

解密出c2地址"www.practicalmalwareanalysis.com"。下面的运算函数我们直接通过动态调试直接查看结果就能得到解密后的数据。这是一步混淆静态分析技术

![1571284527839](1571284527839.png)

![1571284608742](1571284608742.png)

无限循环的socket连接远程地址的9999端口。

![1571287397481](1571287397481.png)

创建简单后门进程。将stdin、stdout、stderr都绑定到socket上，所有cmd.exe产生的输入输出都由socket，实现一个简单的反向shell

![1571285544074](1571285544074.png)

因为远程域名已经实效，我们通过DNS转发软件ApateDNS来将对远程服务器的DNS请求有本地IP响应回去。另外我们需要用nc来模拟远程服务端来监听连接

![1571292531907](1571292531907.png)

接着开启DNS转发，并且启动样本来进行连接

![1571292831032](1571292831032.png)

命令执行成功

![1571292894877](1571292894877.png)

### 总结

1. 样本需要文件名称为 "ocl.exe"才可以继续运行
2. 解密出远程服务器域名
3. 创建无窗口的反向shell

## 实例2

Lab09-03.exe

DLL1.dll

DLL2.dll

DLL3.dll

#### 怎么区分DLL动态加载还是静态加载？

* 静态分析：从导入表中可以看到静态导入的导入表

![1571297696834](1571297696834.png)

静态加载的DLL库，一导入OD就可以在内存映射中看见，Alt+M

![1571297893847](1571297893847.png)

动态加载的DLL3，在执行完LoadLibraryA就可以在内存映射中看见

![1571298057810](1571298057810.png)

#### 多个DLL相同虚拟地址如何加载？

3个DLL各个区段的虚拟地址都相同的情况下。

![1571297010156](1571297010156.png)

但是很明显加载器会动态修改另外两个DLL库的内存地址

![1571298267714](1571298267714.png)

#### IDA里怎么将数据转成结构体？

Lab09-03.exe里设置计划任务的时候，第二个参数Buffer由DLL中提供

![1571301748053](1571301748053.png)

DLL3内Buffer变量由全局变量dword_1000B0A0赋值，我们交叉引用发现是DllMain函数进行了赋值

![1571301954993](1571301954993.png)

进入发现其实地址的数据都未识别出来，我们根据MSDN上的介绍，发现是AF_INFO结构体，下面我们进行手动添加

![1571302043715](1571302043715.png)

![1571302076402](1571302076402.png)

首先进入Structures窗口，Insert->Add standard structure，选中我们需要添加的结构体AT_INFO。

然后双击进入这个全局变量的内存位置，选中"Alt+Q"或者Edit->Struct var...，选中我们引入的结构体，回到汇编代码出可以看见这边的变量名已经改变，让代码更易读

![1571302968643](1571302968643.png)

# 知识补充

## 汇编指令

1. qmemcpy：结合下面两条指令的解释，可以用rep movsd + movsb，进行字符串的复制操作

| 指令      | 解释                                                         |
| --------- | ------------------------------------------------------------ |
| rep movsd | 2条指令，ecx != 0时，重复进行"movsd ES:EDI, DS:ESI"，并且每次传递dword长度，也就是2个字的数据，每进行一次ecx自减1，edi和esi自增1，直到ecx==0为止 |
| movsb     | 传递1字节数据，edi和esi自增1                                 |
| stosd     | 将eax中四字节数据拷贝到ES:EDI指向的地址                      |
| stosb     | 将eax中1字节数据拷贝到ES:EDI指向的地址                       |

